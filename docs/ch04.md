# CH04. 스웜을 이용한 실전 어플리케이션 개발

## 1. 웹 어플리케이션 구성

- 어플리케이션의 요구 조건
    - TODO를 등록, 수정, 삭제할 수 있다.
    - 등록된 TODO의 목록을 출력할 수 있다.
    - 브라우저에서 사용할 수 있는 웹 어플리케이션이다.
- 아키텍처
    - 오케스트레이션 시스템은 도커 스웜 사용
    - `[아키텍처]`
    - 구성 요소

        |이미지명|용도|서비스명|스택명|
        |:---|:---|:---|:---|
        |MysQL|데이터스토어|mysql_master, mysql_slave|MySQL|
        |API|데이터스토어를 다룰 API 서버|app_api|Application|
        |Web|뷰 생성을 담당하는 어플리케이션 서버|frontend_web|Frontend|
        |Nginx|프록시 서버|app_nginx, frontend_nginx|Appication Frontend|
    
    - MySQL
        - 데이터 스토어
        - 마스터-슬래브 구조로 마스터에 저장, 슬레이브로 읽기
    - API
        - RESTful API
        - DB에 접근한다.
    - 웹 UI
        - DB에 접근하지 않고 API를 경유한다.
        - Node.js를 사용한다.
- Nginx
    - 캐싱, 백엔드에 대한 유연한 라우팅, 접근 로그 생성 등의 역할을 겸한다.
    - 배치 전략
        - `[배치전략]`
        - `docker container exec -it manager docker network create --driver=overlay --attachable todoapp` : 네트워크 생성
- TODO 어플리케이션의 전체 구조
    - 데이터 스토어 역할을 할 MySQL 서비스를 마스터-슬레이브 구조로 구축
    - MySQL과 데이터를 주고받을 API 구현
    - Nginx를 웹 어플리케이션과 API 사에서 리버스 프록세 역할을 하도록 설정
    - API를 사용해 서버 사이드 렌더링을 수행할 웹 어플리케이션 구현
    - 프론트엔드 쪽에 리버스 프록시 배치

## 2. MySQL 서비스 구축

- MySQL 이미지를 만들기 위한 리포지토리 클론
    - `git clone httpd://github.com/gihyodocker/tododb`
    - clone 받은 리포지토리를 기반으로 이미지를 구성한다.
- 데이터베이스 컨테이너 구성
    - MySQL 컨테이너는 도커 허브에 등록된 mysql:5.7 이미지를 기반으로 생성한다.
    - 마스터-블레이브 컨테이너는 두 역할을 모두 수행할 수 있는 하나의 이미지로 생성한다.
    - MYSQL_MASTER 환경 변수의 유무에 따라 컨테이너가 서로 마스터로 동작할지, 슬레이브로 동작할지가 결정된다.
    - replicas 값을 조절해 슬레이브를 늘릴 수 있게 한다. 이때 마스터, 슬레이브 모두 일시 정지(다운타임)를 허용한다.
- 인증 정보
    - master

        |환경 변수 이름|내용|값|
        |:---|:---|:---|
        |MYSQL_ROOT_PASSWORD|root 사용자 패스워드|gihyo|
        |MYSQL_DATABASE|TODO 어플리케이션에서 사용할 데이터 베이스|tododb|
        |MYSQL_USER|데이터베이스 사용자명|gihyo|
        |MYSQL_PASSWORD|패스워드|gihyo|
        |MYSQL_MASTER|마스터 여부|true|

    - slave

        |환경 변수 이름|내용|값|
        |:---|:---|:---|
        |MYSQL_MASTER_HOST|마스터 호스트명|master|
        |MYSQL_ROOT_PASSWORD|root 사용자 패스워드|gihyo|
        |MYSQL_DATABASE|TODO 어플리케이션에서 사용할 데이터베이스|tododb|
        |MYSQL_USER|데이터베이스 사용자명|gihyo|
        |MYSQL_PASSWORD|패스워드|gihyo|
        |MYSQL_REPL_USER|마스터에 등록할 레플리케이션 사용자|repl|
        |MYSQL_REPL_PASSWORD|레플리케이션 사용자 패스워드|gihyo|

- MySQL 설정 : etc/mysql/mysql.conf.d/mysqld.cnf
    ```cnf
    [mysqld]
    character-set-server = utf8mb4
    collation-server = utf8mb4_general_ci
    pid-file        = /var/run/mysqld/mysqld.pid
    socket          = /var/run/mysqld/mysqld.sock
    datadir         = /var/lib/mysql
    #log-error      = /var/log/mysql/error.log
    # By default we only accept connections from localhost
    #bind-address   = 127.0.0.1
    # Disabling symbolic-links is recommended to prevent assorted security risks
    symbolic-links=0
    relay-log=mysqld-relay-bin
    relay-log-index=mysqld-relay-bin

    log-bin=/var/log/mysql/mysql-bin.log

    ```
    - log-bin
        - 레플리케이션을사용하려면 바이너리 로그가 필요하다.
        - log-bin은 마스터와 슬레이브 모두 사용하기 때문에 설정에 차이가 없다.
    - server-id
        - MySQL 서버를 식별하기 위한 유일 값이다.
        - 마스터와 슬레이브로 구성된 스택 안에서 중복이 없도록 설정해야한다.
        - log-bin 아래줄에 생성되도록 tododb/add-server-id.sh에 아래와 같이 작성한다.
            ```sh
            #!/bin/bash -e
            OCTETS=(`hostname -i | tr -s '.' ' '`)

            MYSQL_SERVER_ID=`expr ${OCTETS[2]} \* 256 + ${OCTETS[3]}`
            echo "server-id=$MYSQL_SERVER_ID" >> /etc/mysql/mysql.conf.d/mysqld.cnf
            ```
            - 컨테이너의 IP 주소에서 3,4 번째 옥텟 값을 뽑아 서버 간에 중복되지 않는 server-id 값을 설정한다.
- 레플리케이션 설정
    - tododb/prepare.sh
        ```sh
        #!/bin/bash -e

        # (1) 환경 변수로 마스터와 슬레이브 지정
        if [ ! -z "$MYSQL_MASTER" ]; then
        echo "this container is master"
        return 0
        fi

        echo "prepare as slave"

        # (2) 슬레이브에서 마스터와 통신 가능 여부
        if [ -z "$MYSQL_MASTER_HOST" ]; then
        echo "mysql_master_host is not specified" 1>&2
        return 1
        fi

        while :
        do
            if mysql -h $MYSQL_MASTER_HOST -u root -p$MYSQL_ROOT_PASSWORD -e "quit" > /dev/null 2>&1 ; then
                echo "MySQL master is ready!"
                break
            else
                echo "MySQL master is not ready"
            fi
            sleep 3
        done

        # (3) 마스터에 레플리케이션용 사용자 생성 및 권한 부여
        IP=`hostname -i`
        IFS='.'
        set -- $IP
        SOURCE_IP="$1.$2.%.%"
        mysql -h $MYSQL_MASTER_HOST -u root -p$MYSQL_ROOT_PASSWORD -e "CREATE USER IF NOT EXISTS '$MYSQL_REPL_USER'@'$SOURCE_IP' IDENTIFIED BY '$MYSQL_REPL_PASSWORD';"
        mysql -h $MYSQL_MASTER_HOST -u root -p$MYSQL_ROOT_PASSWORD -e "GRANT REPLICATION SLAVE ON *.* TO '$MYSQL_REPL_USER'@'$SOURCE_IP';"

        # (4) 마스터에 binlog 포지션 정보 확인
        MASTER_STATUS_FILE=/tmp/master-status
        mysql -h $MYSQL_MASTER_HOST -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW MASTER STATUS\G" > $MASTER_STATUS_FILE
        BINLOG_FILE=`cat $MASTER_STATUS_FILE | grep File | xargs | cut -d' ' -f2`
        BINLOG_POSITION=`cat $MASTER_STATUS_FILE | grep Position | xargs | cut -d' ' -f2`
        echo "BINLOG_FILE=$BINLOG_FILE"
        echo "BINLOG_POSITION=$BINLOG_POSITION"

        # (5) 레플리케이션 시작
        mysql -u root -p$MYSQL_ROOT_PASSWORD -e "CHANGE MASTER TO MASTER_HOST='$MYSQL_MASTER_HOST', MASTER_USER='$MYSQL_REPL_USER', MASTER_PASSWORD='$MYSQL_REPL_PASSWORD', MASTER_LOG_FILE='$BINLOG_FILE', MASTER_LOG_POS=$BINLOG_POSITION;"
        mysql -u root -p$MYSQL_ROOT_PASSWORD -e "START SLAVE;"

        echo "slave started"

        ```
        1. 환경 변수에 따라 마스터/슬레이브로 설정
            - MYSQL_MASTER 값에 따라 마스터 혹은 슬레이브로 동작
        2. 슬레이브와 마스터 간의 통신 확인
            - 슬레이브에서 마스터에 MySQL 명령ㅇ르 실행하려면 호스트명을 -h 옵션값으로 주면 된다.
            - 3초마다 마스터와 통신을 확인해 확인되는 경우 무한 루프에서 바로 탈출한다.
        3. 마스터에 레플리카 사용자 및 권한추가
        4. 마스터 binlog의 포지션 설정
        5. 레플리케이션 시작
- MySQL(master/slave) Dockerfile
    ```Dockerfile
    FROM mysql:5.7

    # (1) 패키지 업데이트 및 wget 설치
    RUN apt-get update
    RUN apt-get install -y wget

    # (2) entrykit 설치
    RUN wget https://github.com/progrium/entrykit/releases/download/v0.4.0/entrykit_0.4.0_linux_x86_64.tgz
    RUN tar -xvzf entrykit_0.4.0_linux_x86_64.tgz
    RUN rm entrykit_0.4.0_linux_x86_64.tgz
    RUN mv entrykit /usr/local/bin/
    RUN entrykit --symlink

    # (3) 스크립트 및 각종 설정 파일 복사
    COPY add-server-id.sh /usr/local/bin/
    COPY etc/mysql/mysql.conf.d/mysqld.cnf /etc/mysql/mysql.conf.d/
    COPY etc/mysql/conf.d/mysql.cnf /etc/mysql/conf.d/
    COPY prepare.sh /docker-entrypoint-initdb.d
    COPY init-data.sh /usr/local/bin/
    COPY sql /sql

    # (4) 스크립트, mysqld 실행
    ENTRYPOINT [ \
        "prehook", \
        "add-server-id.sh", \
        "--", \
        "docker-entrypoint.sh" \
    ]

    CMD ["mysqld"]
    ```
    1. wget 설치
    2. entrykit 설치
    3. MySQL 컨테이너를 구성하기 위한 파일과 스크립트를 COPY
    4. 스크립트 및 mysqld 실행
        - ENTRYPOINT 인스트럭션 값 안에 지정된 docker-entrypoint.sh 스크립트는 tododb에는 없지만 기반 이미지인 mysql:5.7에 포함된 파일이므로 실행할 수 있다.
        - 이 이미지는 데이터베이스 서버 시작이 완료된 시점마다 /docker-entrypoint-initdb.d 디렉터리에 위치한 스크립트를 실행한다.
        - add-server-id.sh 스크립트를 docker-entrypoint.sh보다 먼저 실행할 수 있다.
- 빌드
    ```
    $ docker image build -t tododb:latest .
    $ docker image tag tododb:latest localhost:5000/tododb:latest
    $ docker push localhost:5000/tododb:latest
    ```
- 스웜에서 마스터 및 슬레이브 실행
- MySQL 컨테이너 확인 및 초기 데이터 투입

## 3. API 서비스 구축

- todoapi의 기본 구조
- 어플리케이션 환경 변수 통제
- MySQL 접속 및 테이블 매핑
- 핸들러 구현하기
- servePUT
- API를 위한 Dockerfile
- 스웜에서 todoapi 서비스 실행하기

## 4. Nginx 구축

- nginx.conf 파일 구성하기
- Nginx 컨테이너의 Dockerfile
- Nginx를 거쳐 API에 접근하기

## 5. 웹 서비스 구축

- TODO API 호출 및 페이지 HTML 렌더링
- 웹 서비스의 Dockerfile
- 정적 파일을 다루는 방법
- Nginx를 통한 접근 허용
- 인그레스로 서비스 노출하기

## 6. 컨테이너 오케스트레이션을 적용한 개발 스타일